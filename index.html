<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Material Delivery Plan | ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</title>
    <meta name="description" content="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö Material Delivery Plan Dashboard">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { inter: ['Inter', 'sans-serif'] },
                }
            }
        }
    </script>
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        body {
            background: #f0f4f8;
            min-height: 100vh;
        }

        .card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.03);
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.1);
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pulse-dot {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .tab-active {
            border-bottom: 3px solid #6366f1;
            color: #4f46e5;
            font-weight: 600;
        }

        .remaining-negative {
            color: #dc2626;
            font-weight: 700;
        }

        .remaining-positive {
            color: #059669;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #818cf8);
            color: #fff;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #f87171);
            color: #fff;
            transition: all 0.2s;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            transform: scale(1.02);
        }

        .stat-card-1 {
            background: linear-gradient(135deg, #ede9fe, #ddd6fe);
            border: 1px solid #c4b5fd;
        }

        .stat-card-2 {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border: 1px solid #93c5fd;
        }

        .stat-card-3 {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border: 1px solid #6ee7b7;
        }

        .stat-card-4 {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid #fcd34d;
        }

        .header-bar {
            background: linear-gradient(135deg, #6366f1, #818cf8);
        }

        input,
        select {
            transition: all 0.2s;
        }

        input:focus,
        select:focus {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        table tbody tr {
            transition: background 0.15s;
        }
    </style>
</head>

<body class="text-gray-700 font-inter">

    <!-- Header -->
    <header class="header-bar sticky top-0 z-50 shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-white/20 backdrop-blur flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg sm:text-xl font-bold text-white">Material Delivery Plan</h1>
                    <p class="text-xs text-indigo-100 hidden sm:block">‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="hidden sm:flex items-center gap-2 text-xs text-indigo-100 mr-4">
                    <span class="w-2 h-2 rounded-full bg-green-300 pulse-dot"></span>
                    <span id="statusText">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                </div>
                <button onclick="confirmReset()"
                    class="px-3 py-2 rounded-lg text-xs font-medium bg-white/15 text-white border border-white/20 hover:bg-white/25 transition-all"
                    title="Reset ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">
                    <span class="hidden sm:inline">üóë Reset ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span><span class="sm:hidden">üóë</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-6 space-y-6 fade-in">

        <!-- Stats Cards -->
        <div id="statsCards" class="grid grid-cols-2 lg:grid-cols-4 gap-4"></div>

        <!-- Tabs -->
        <div class="flex border-b border-gray-200 gap-1 bg-white rounded-t-xl px-2 pt-2 overflow-x-auto">
            <button onclick="switchTab('dashboard')" id="tabDashboard"
                class="px-4 py-3 text-sm font-medium text-gray-500 hover:text-indigo-600 transition-colors tab-active whitespace-nowrap">üìä
                Dashboard</button>
            <button onclick="switchTab('master')" id="tabMaster"
                class="px-4 py-3 text-sm font-medium text-gray-500 hover:text-indigo-600 transition-colors whitespace-nowrap">üì¶
                Master Data</button>
            <button onclick="switchTab('delivery')" id="tabDelivery"
                class="px-4 py-3 text-sm font-medium text-gray-500 hover:text-indigo-600 transition-colors whitespace-nowrap">üöö
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</button>
            <button onclick="switchTab('calendar')" id="tabCalendar"
                class="px-4 py-3 text-sm font-medium text-gray-500 hover:text-indigo-600 transition-colors whitespace-nowrap">üìÖ
                ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</button>
        </div>

        <!-- Dashboard Tab -->
        <section id="secDashboard" class="space-y-4">
            <div class="card rounded-2xl p-5">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-3">
                    <h2 class="text-base font-semibold text-gray-800">üìä ‡∏™‡∏£‡∏∏‡∏õ Forecast vs. ‡∏¢‡∏≠‡∏î‡∏™‡πà‡∏á</h2>
                    <div class="flex items-center gap-3">
                        <label class="text-xs text-gray-500 font-medium">‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
                        <select id="filterMonth" onchange="renderAll()"
                            class="px-3 py-1.5 rounded-lg bg-gray-50 border border-gray-200 text-sm text-gray-700 focus:outline-none focus:border-indigo-400 focus:ring-1 focus:ring-indigo-300">
                            <option value="all">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        </select>
                        <span class="text-xs text-gray-400" id="skuCount"></span>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left text-gray-500 border-b border-gray-100 bg-gray-50/50">
                                <th class="py-3 px-3 font-semibold rounded-tl-lg">#</th>
                                <th class="py-3 px-3 font-semibold">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU)</th>
                                <th class="py-3 px-3 font-semibold text-center">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                                <th class="py-3 px-3 font-semibold text-right">Forecast</th>
                                <th class="py-3 px-3 font-semibold text-right">‡∏¢‡∏≠‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</th>
                                <th class="py-3 px-3 font-semibold text-right">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                                <th class="py-3 px-3 font-semibold text-center rounded-tr-lg">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardBody" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
                <div id="emptyDashboard" class="hidden text-center py-12 text-gray-400">
                    <p class="text-4xl mb-2">üì≠</p>
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SKU ‚Äî ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö Master Data</p>
                </div>
            </div>
        </section>

        <!-- Master Data Tab -->
        <section id="secMaster" class="hidden space-y-4">
            <div class="card rounded-2xl p-5">
                <h2 class="text-base font-semibold mb-4 text-gray-800">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU) ‡∏û‡∏£‡πâ‡∏≠‡∏° Forecast</h2>
                <form onsubmit="addSKU(event)" class="flex flex-col sm:flex-row gap-3 flex-wrap">
                    <input id="inputSKU" type="text" list="skuDatalist" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô RM-001" required
                        class="flex-1 px-4 py-2.5 rounded-xl bg-gray-50 border border-gray-200 text-sm text-gray-700 placeholder-gray-400 focus:outline-none focus:border-indigo-400 focus:ring-1 focus:ring-indigo-300">
                    <datalist id="skuDatalist"></datalist>
                    <input id="inputMonth" type="month" required
                        class="px-4 py-2.5 rounded-xl bg-gray-50 border border-gray-200 text-sm text-gray-700 focus:outline-none focus:border-indigo-400 focus:ring-1 focus:ring-indigo-300">
                    <input id="inputForecast" type="number" min="0" step="any" placeholder="‡∏¢‡∏≠‡∏î Forecast" required
                        class="w-full sm:w-40 px-4 py-2.5 rounded-xl bg-gray-50 border border-gray-200 text-sm text-gray-700 placeholder-gray-400 focus:outline-none focus:border-indigo-400 focus:ring-1 focus:ring-indigo-300">
                    <button type="submit"
                        class="btn-primary px-6 py-2.5 rounded-xl text-sm font-semibold shadow-md">‡πÄ‡∏û‡∏¥‡πà‡∏° SKU</button>
                </form>
            </div>
            <div class="card rounded-2xl p-5">
                <h2 class="text-base font-semibold mb-4 text-gray-800">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ SKU ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left text-gray-500 border-b border-gray-100 bg-gray-50/50">
                                <th class="py-3 px-3 font-semibold">#</th>
                                <th class="py-3 px-3 font-semibold">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th class="py-3 px-3 font-semibold text-right">Forecast</th>
                                <th class="py-3 px-3 font-semibold text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="masterBody" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
                <div id="emptyMaster" class="hidden text-center py-12 text-gray-400">
                    <p class="text-4xl mb-2">üì¶</p>
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ SKU ‚Äî ‡∏Å‡∏£‡∏≠‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°</p>
                </div>
            </div>
        </section>

        <!-- Delivery Tab -->
        <section id="secDelivery" class="hidden space-y-4">
            <div class="card rounded-2xl p-5">
                <h2 class="text-base font-semibold mb-4 text-gray-800">üöö ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</h2>
                <form onsubmit="addDelivery(event)" class="flex flex-col sm:flex-row gap-3 flex-wrap">
                    <input id="inputDate" type="date" required
                        class="px-4 py-2.5 rounded-xl bg-gray-50 border border-gray-200 text-sm text-gray-700 focus:outline-none focus:border-indigo-400 focus:ring-1 focus:ring-indigo-300">
                    <select id="selectSKU" required
                        class="flex-1 px-4 py-2.5 rounded-xl bg-gray-50 border border-gray-200 text-sm text-gray-700 focus:outline-none focus:border-indigo-400 focus:ring-1 focus:ring-indigo-300">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å SKU --</option>
                    </select>
                    <input id="inputLot" type="text" placeholder="Lot No."
                        class="w-full sm:w-32 px-4 py-2.5 rounded-xl bg-gray-50 border border-gray-200 text-sm text-gray-700 placeholder-gray-400 focus:outline-none focus:border-indigo-400 focus:ring-1 focus:ring-indigo-300">
                    <input id="inputQty" type="number" min="0.01" step="any" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á" required
                        class="w-full sm:w-40 px-4 py-2.5 rounded-xl bg-gray-50 border border-gray-200 text-sm text-gray-700 placeholder-gray-400 focus:outline-none focus:border-indigo-400 focus:ring-1 focus:ring-indigo-300">
                    <button type="submit"
                        class="btn-primary px-6 py-2.5 rounded-xl text-sm font-semibold shadow-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </form>
            </div>
            <div class="card rounded-2xl p-5">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-base font-semibold text-gray-800">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                    <span class="text-xs text-gray-400" id="deliveryCount"></span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left text-gray-500 border-b border-gray-100 bg-gray-50/50">
                                <th class="py-3 px-3 font-semibold">#</th>
                                <th class="py-3 px-3 font-semibold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th class="py-3 px-3 font-semibold">SKU</th>
                                <th class="py-3 px-3 font-semibold">Lot</th>
                                <th class="py-3 px-3 font-semibold text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                <th class="py-3 px-3 font-semibold text-center">‡∏•‡∏ö</th>
                            </tr>
                        </thead>
                        <tbody id="deliveryBody" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
                <div id="emptyDelivery" class="hidden text-center py-12 text-gray-400">
                    <p class="text-4xl mb-2">üöö</p>
                    <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</p>
                </div>
            </div>
        </section>

        <!-- Calendar Tab -->
        <section id="secCalendar" class="hidden space-y-4">
            <!-- Summary Banner -->
            <div class="flex flex-wrap gap-3"></div>
            <div
                class="card rounded-xl px-4 py-2.5 bg-gradient-to-r from-indigo-500 to-violet-500 text-white inline-flex items-center gap-2">
                <p class="text-sm font-medium text-indigo-100">üìã ‡πÅ‡∏ú‡∏ô‡∏™‡πà‡∏á</p>
                <p class="text-xl font-bold" id="calBannerPlan">0</p>
                <p class="text-xs text-indigo-200">‡∏´‡∏ô‡πà‡∏ß‡∏¢</p>
            </div>
            <div
                class="card rounded-xl px-4 py-2.5 bg-gradient-to-r from-emerald-500 to-teal-500 text-white inline-flex items-center gap-2">
                <p class="text-sm font-medium text-emerald-100">‚úÖ ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</p>
                <p class="text-xl font-bold" id="calBannerActual">0</p>
                <p class="text-xs text-emerald-200">‡∏´‡∏ô‡πà‡∏ß‡∏¢</p>
            </div>
            <div
                class="card rounded-xl px-4 py-2.5 bg-gradient-to-r from-amber-500 to-orange-500 text-white inline-flex items-center gap-2">
                <p class="text-sm font-medium text-amber-100">üìà ‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</p>
                <p class="text-xl font-bold" id="calBannerPct">0%</p>
            </div>
            </div>
            <!-- SKU Color Legend -->
            <div class="card rounded-2xl p-4">
                <p class="text-xs font-semibold text-gray-500 mb-2">üé® ‡∏™‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</p>
                <div id="calLegend" class="flex flex-wrap gap-2"></div>
            </div>
            <!-- Calendar Grid -->
            <div class="card rounded-2xl p-5">
                <div class="flex items-center justify-between mb-4">
                    <button onclick="calPrev()"
                        class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600 transition-all text-sm font-medium">‚óÄ
                        ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                    <h2 class="text-base font-semibold text-gray-800" id="calTitle">üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</h2>
                    <button onclick="calNext()"
                        class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600 transition-all text-sm font-medium">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                        ‚ñ∂</button>
                </div>
                <div class="grid grid-cols-7 gap-px bg-gray-200 rounded-xl overflow-hidden border border-gray-200">
                    <div class="bg-indigo-50 text-center py-2 text-xs font-semibold text-indigo-600">‡∏≠‡∏≤</div>
                    <div class="bg-indigo-50 text-center py-2 text-xs font-semibold text-indigo-600">‡∏à</div>
                    <div class="bg-indigo-50 text-center py-2 text-xs font-semibold text-indigo-600">‡∏≠</div>
                    <div class="bg-indigo-50 text-center py-2 text-xs font-semibold text-indigo-600">‡∏û</div>
                    <div class="bg-indigo-50 text-center py-2 text-xs font-semibold text-indigo-600">‡∏û‡∏§</div>
                    <div class="bg-indigo-50 text-center py-2 text-xs font-semibold text-indigo-600">‡∏®</div>
                    <div class="bg-indigo-50 text-center py-2 text-xs font-semibold text-indigo-600">‡∏™</div>
                </div>
                <div id="calGrid"
                    class="grid grid-cols-7 gap-px bg-gray-200 rounded-b-xl overflow-hidden border border-gray-200 border-t-0">
                </div>
            </div>
            <!-- Summary Table -->
            <div class="card rounded-2xl p-5">
                <h2 class="text-base font-semibold text-gray-800 mb-4">üìä ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏ú‡∏ô vs ‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-gray-50/50">
                                <th rowspan="2" class="py-3 px-3 font-semibold text-gray-500 border-b border-gray-100">
                                    ‡∏™‡∏µ</th>
                                <th rowspan="2" class="py-3 px-3 font-semibold text-gray-500 border-b border-gray-100">
                                    ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU)</th>
                                <th colspan="3"
                                    class="py-2 px-3 text-center font-bold text-indigo-600 text-xs border-b-2 border-indigo-300 bg-indigo-50/60">
                                    üìã Forecast vs ‡πÅ‡∏ú‡∏ô‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</th>
                                <th colspan="3"
                                    class="py-2 px-3 text-center font-bold text-emerald-600 text-xs border-b-2 border-emerald-300 bg-emerald-50/60">
                                    ‚úÖ ‡πÅ‡∏ú‡∏ô‡∏à‡∏±‡∏î‡∏™‡πà‡∏á vs ‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á</th>
                            </tr>
                            <tr class="text-left text-gray-500 border-b border-gray-100 bg-gray-50/30 text-xs">
                                <th class="py-2 px-3 font-semibold text-right bg-indigo-50/30">Forecast</th>
                                <th class="py-2 px-3 font-semibold text-right bg-indigo-50/30">‡πÅ‡∏ú‡∏ô‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</th>
                                <th class="py-2 px-3 font-semibold text-right bg-indigo-50/30 border-r border-gray-200">
                                    ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                                <th class="py-2 px-3 font-semibold text-right bg-emerald-50/30">‡πÅ‡∏ú‡∏ô‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</th>
                                <th class="py-2 px-3 font-semibold text-right bg-emerald-50/30">‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á</th>
                                <th class="py-2 px-3 font-semibold text-right bg-emerald-50/30">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                            </tr>
                        </thead>
                        <tbody id="calSummaryBody" class="divide-y divide-gray-50"></tbody>
                        <tfoot id="calSummaryFoot" class="border-t-2 border-gray-200"></tfoot>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="text-center py-6 text-xs text-gray-400">
        Material Delivery Plan ¬© 2026 ‚Äî ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Google Sheets
    </footer>

    <!-- Edit SKU Modal -->
    <div id="editModal" class="fixed inset-0 z-[90] hidden">
        <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" onclick="closeEditModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md">
            <div class="bg-white rounded-2xl shadow-2xl border border-gray-100 p-6 mx-4">
                <h3 class="text-lg font-bold text-gray-800 mb-4">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç SKU</h3>
                <input type="hidden" id="editIdx">
                <div class="space-y-3">
                    <div>
                        <label class="text-xs font-medium text-gray-500 mb-1 block">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU)</label>
                        <input id="editName" type="text"
                            class="w-full px-4 py-2.5 rounded-xl bg-gray-50 border border-gray-200 text-sm text-gray-700 focus:outline-none focus:border-indigo-400 focus:ring-1 focus:ring-indigo-300">
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-500 mb-1 block">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                        <input id="editMonth" type="month"
                            class="w-full px-4 py-2.5 rounded-xl bg-gray-50 border border-gray-200 text-sm text-gray-700 focus:outline-none focus:border-indigo-400 focus:ring-1 focus:ring-indigo-300">
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-500 mb-1 block">‡∏¢‡∏≠‡∏î Forecast</label>
                        <input id="editForecast" type="number" min="0" step="any"
                            class="w-full px-4 py-2.5 rounded-xl bg-gray-50 border border-gray-200 text-sm text-gray-700 focus:outline-none focus:border-indigo-400 focus:ring-1 focus:ring-indigo-300">
                    </div>
                </div>
                <div class="flex gap-3 mt-5">
                    <button onclick="closeEditModal()"
                        class="flex-1 px-4 py-2.5 rounded-xl text-sm font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-all">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button onclick="saveEditSKU()"
                        class="flex-1 btn-primary px-4 py-2.5 rounded-xl text-sm font-semibold shadow-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 z-[100] hidden">
        <div
            class="bg-white rounded-xl px-5 py-3 text-sm font-medium shadow-xl border border-gray-100 flex items-center gap-2">
            <span id="toastIcon">‚úÖ</span><span id="toastMsg" class="text-gray-700"></span>
        </div>
    </div>

    <script>
        // ===== DATA LAYER (Google Sheets Only ‚Äî No localStorage) =====
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbz5ldb77ZPheaxRSUcxT76oNlaQeJ02znXaLHxujNoNQLCcG4w_8t63aOW53i6Q_-yT/exec';

        // In-memory data store
        let _skus = [];
        let _deliveries = [];
        let _plans = [];

        function loadSKUs() { return _skus; }
        function saveSKUs(data) { _skus = data; syncToSheet('SKUs', data); }
        function loadDeliveries() { return _deliveries; }
        function saveDeliveries(data) { _deliveries = data; syncToSheet('Deliveries', data); }
        function loadPlans() { return _plans; }
        function savePlans(data) { _plans = data; syncToSheet('Plans', data); }

        // ===== SYNC TO GOOGLE SHEETS =====
        function syncToSheet(sheetName, data) {
            if (!GAS_URL) return;
            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ action: 'save', sheet: sheetName, data: data })
            }).then(r => r.json()).then(res => {
                console.log('Synced ' + sheetName + ':', res);
            }).catch(err => console.warn('Sync error:', err));
        }

        // ===== NORMALIZE DATE (‡∏à‡∏≤‡∏Å Google Sheets) =====
        function normalizeDate(val) {
            if (!val) return '';
            const s = String(val);
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ T (ISO format) ‚Üí parse ‡πÄ‡∏õ‡πá‡∏ô Date ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ local time
            if (s.includes('T')) {
                const d = new Date(s);
                if (!isNaN(d)) return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
            }
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏¢
            if (s.length >= 10 && s[4] === '-' && s[7] === '-') return s.substring(0, 10);
            // ‡∏•‡∏≠‡∏á parse format ‡∏≠‡∏∑‡πà‡∏ô
            const d = new Date(s);
            if (!isNaN(d)) return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
            return s;
        }

        // ===== LOAD FROM GOOGLE SHEETS (on startup) =====
        async function loadFromSheets() {
            if (!GAS_URL) { console.log('GAS_URL not set'); return; }
            try {
                showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...', 'üîÑ');
                const [skus, dels, plans] = await Promise.all([
                    fetch(GAS_URL + '?action=read&sheet=SKUs').then(r => r.json()),
                    fetch(GAS_URL + '?action=read&sheet=Deliveries').then(r => r.json()),
                    fetch(GAS_URL + '?action=read&sheet=Plans').then(r => r.json())
                ]);
                // Normalize dates
                if (Array.isArray(skus)) _skus = skus.map(s => ({ ...s, month: s.month ? normalizeDate(s.month).substring(0, 7) : '' }));
                if (Array.isArray(dels)) _deliveries = dels.map(d => ({ ...d, date: normalizeDate(d.date) }));
                if (Array.isArray(plans)) _plans = plans.map(p => ({ ...p, date: normalizeDate(p.date) }));
                renderAll();
                showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (' + _skus.length + ' SKUs)', '‚òÅÔ∏è');
            } catch (err) {
                console.warn('Failed to load from Sheets:', err);
                showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ refresh', '‚ùå');
            }
        }

        // ===== SKU COLORS =====
        const SKU_COLORS = [
            { bg: '#fef3c7', border: '#f59e0b', text: '#92400e', name: '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á' },
            { bg: '#fee2e2', border: '#ef4444', text: '#991b1b', name: '‡πÅ‡∏î‡∏á' },
            { bg: '#ffedd5', border: '#ea580c', text: '#c2410c', name: '‡∏™‡πâ‡∏°' },
            { bg: '#d1fae5', border: '#10b981', text: '#065f46', name: '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß' },
            { bg: '#dbeafe', border: '#3b82f6', text: '#1e40af', name: '‡∏ü‡πâ‡∏≤' },
            { bg: '#ede9fe', border: '#8b5cf6', text: '#5b21b6', name: '‡∏°‡πà‡∏ß‡∏á' },
            { bg: '#fce7f3', border: '#ec4899', text: '#9d174d', name: '‡∏ä‡∏°‡∏û‡∏π' },
            { bg: '#e0e7ff', border: '#6366f1', text: '#3730a3', name: '‡∏Ñ‡∏£‡∏≤‡∏°' },
            { bg: '#ccfbf1', border: '#14b8a6', text: '#134e4a', name: '‡πÄ‡∏ó‡∏≠‡∏Ñ‡∏ß‡∏≠‡∏¢‡∏™‡πå' },
            { bg: '#fef9c3', border: '#eab308', text: '#854d0e', name: '‡∏ó‡∏≠‡∏á' },
        ];
        function getSkuColor(skuName) {
            const nameLower = skuName.toLowerCase();
            // Match color by keyword in SKU name
            if (nameLower.includes('‡∏™‡πâ‡∏°') || nameLower.includes('orange')) {
                return { bg: '#ffedd5', border: '#ea580c', text: '#c2410c', name: '‡∏™‡πâ‡∏°' };
            }
            if (nameLower.includes('‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß') || nameLower.includes('green')) {
                return { bg: '#d1fae5', border: '#10b981', text: '#065f46', name: '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß' };
            }
            if (nameLower.includes('‡πÅ‡∏î‡∏á') || nameLower.includes('red')) {
                return { bg: '#fee2e2', border: '#ef4444', text: '#991b1b', name: '‡πÅ‡∏î‡∏á' };
            }
            if (nameLower.includes('‡∏ü‡πâ‡∏≤') || nameLower.includes('blue')) {
                return { bg: '#dbeafe', border: '#3b82f6', text: '#1e40af', name: '‡∏ü‡πâ‡∏≤' };
            }
            if (nameLower.includes('‡∏°‡πà‡∏ß‡∏á') || nameLower.includes('purple')) {
                return { bg: '#ede9fe', border: '#8b5cf6', text: '#5b21b6', name: '‡∏°‡πà‡∏ß‡∏á' };
            }
            if (nameLower.includes('‡∏ä‡∏°‡∏û‡∏π') || nameLower.includes('pink')) {
                return { bg: '#fce7f3', border: '#ec4899', text: '#9d174d', name: '‡∏ä‡∏°‡∏û‡∏π' };
            }
            if (nameLower.includes('‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á') || nameLower.includes('yellow')) {
                return { bg: '#fef08a', border: '#facc15', text: '#854d0e', name: '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á' };
            }
            if (nameLower.includes('‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•') || nameLower.includes('brown')) {
                return { bg: '#fef3c7', border: '#a16207', text: '#78350f', name: '‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•' };
            }
            // Fallback: use index-based color
            const skus = loadSKUs();
            const names = [...new Set(skus.map(s => s.name))];
            const idx = names.indexOf(skuName);
            return SKU_COLORS[idx >= 0 ? idx % SKU_COLORS.length : 0];
        }

        // ===== TABS =====
        function switchTab(tab) {
            document.querySelectorAll('[id^="sec"]').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('[id^="tab"]').forEach(t => t.classList.remove('tab-active'));
            const id = tab.charAt(0).toUpperCase() + tab.slice(1);
            document.getElementById('sec' + id).classList.remove('hidden');
            document.getElementById('tab' + id).classList.add('tab-active');
        }

        // ===== TOAST =====
        function showToast(msg, icon = '‚úÖ') {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = msg;
            document.getElementById('toastIcon').textContent = icon;
            t.classList.remove('hidden');
            clearTimeout(t._tid);
            t._tid = setTimeout(() => t.classList.add('hidden'), 2500);
        }

        // ===== FORMAT =====
        function fmt(n) { return Number(n).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 }); }

        const MONTH_NAMES_TH = ['', '‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
        function fmtMonth(m) {
            if (!m) return '-';
            const [y, mm] = m.split('-');
            return MONTH_NAMES_TH[parseInt(mm)] + ' ' + y;
        }

        // ===== RENDER STATS =====
        function renderStats() {
            const allSkus = loadSKUs(), dels = loadDeliveries();
            const filterVal = document.getElementById('filterMonth').value;
            const skus = filterVal === 'all' ? allSkus : allSkus.filter(s => s.month === filterVal);
            const totalForecast = skus.reduce((s, i) => s + Number(i.forecast), 0);
            const filteredDels = filterVal === 'all' ? dels : dels.filter(d => d.date.substring(0, 7) === filterVal);
            const totalDelivered = filteredDels.reduce((s, i) => s + Number(i.qty), 0);
            const remaining = totalForecast - totalDelivered;
            const pct = totalForecast > 0 ? Math.min((totalDelivered / totalForecast) * 100, 100) : 0;
            const monthLabel = filterVal === 'all' ? '' : ' (' + fmtMonth(filterVal) + ')';
            document.getElementById('statsCards').innerHTML = `
        <div class="stat-card-1 rounded-2xl p-4 card-hover">
            <p class="text-xs text-indigo-500 font-medium mb-1">üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô SKU${monthLabel}</p>
            <p class="text-2xl font-bold text-indigo-700">${skus.length}</p>
        </div>
        <div class="stat-card-2 rounded-2xl p-4 card-hover">
            <p class="text-xs text-blue-500 font-medium mb-1">üéØ Forecast ‡∏£‡∏ß‡∏°${monthLabel}</p>
            <p class="text-2xl font-bold text-blue-700">${fmt(totalForecast)}</p>
        </div>
        <div class="stat-card-3 rounded-2xl p-4 card-hover">
            <p class="text-xs text-emerald-600 font-medium mb-1">üöö ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏ß‡∏°${monthLabel}</p>
            <p class="text-2xl font-bold text-emerald-700">${fmt(totalDelivered)}</p>
        </div>
        <div class="stat-card-4 rounded-2xl p-4 card-hover">
            <p class="text-xs text-amber-600 font-medium mb-1">üìà ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤${monthLabel}</p>
            <p class="text-2xl font-bold ${remaining < 0 ? 'text-red-600' : 'text-amber-700'}">${pct.toFixed(1)}%</p>
            <div class="mt-2 h-2 w-full bg-white/60 rounded-full overflow-hidden"><div class="h-full rounded-full transition-all duration-500 ${pct >= 100 ? 'bg-red-500' : 'bg-gradient-to-r from-indigo-500 to-blue-400'}" style="width:${Math.min(pct, 100)}%"></div></div>
        </div>`;
        }

        // ===== RENDER MONTH FILTER =====
        function renderMonthFilter() {
            const skus = loadSKUs();
            const months = [...new Set(skus.map(s => s.month).filter(Boolean))].sort();
            const sel = document.getElementById('filterMonth');
            const cur = sel.value;
            sel.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>' + months.map(m => `<option value="${m}">${fmtMonth(m)}</option>`).join('');
            if (months.includes(cur) || cur === 'all') sel.value = cur;
        }

        // ===== RENDER DASHBOARD =====
        function renderDashboard() {
            const allSkus = loadSKUs(), dels = loadDeliveries();
            const filterVal = document.getElementById('filterMonth').value;
            const skus = filterVal === 'all' ? allSkus : allSkus.filter(s => s.month === filterVal);
            const body = document.getElementById('dashboardBody');
            const empty = document.getElementById('emptyDashboard');
            if (skus.length === 0) { body.innerHTML = ''; empty.classList.remove('hidden'); document.getElementById('skuCount').textContent = ''; return; }
            empty.classList.add('hidden');
            document.getElementById('skuCount').textContent = skus.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
            body.innerHTML = skus.map((sku, i) => {
                // Match deliveries: same SKU and delivery date falls in the forecast month
                const delivered = dels.filter(d => d.sku === sku.name && (sku.month ? d.date.substring(0, 7) === sku.month : true)).reduce((s, d) => s + Number(d.qty), 0);
                const remain = Number(sku.forecast) - delivered;
                const isOver = remain < 0;
                const pct = Number(sku.forecast) > 0 ? Math.min((delivered / Number(sku.forecast)) * 100, 100) : 0;
                let badge = '';
                if (remain === 0 && Number(sku.forecast) > 0) badge = '<span class="px-2.5 py-1 rounded-full text-xs bg-emerald-50 text-emerald-600 font-semibold border border-emerald-200">‚úÖ ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>';
                else if (isOver) badge = '<span class="px-2.5 py-1 rounded-full text-xs bg-red-50 text-red-600 font-semibold border border-red-200">‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏ô!</span>';
                else if (pct > 0) badge = '<span class="px-2.5 py-1 rounded-full text-xs bg-blue-50 text-blue-600 font-semibold border border-blue-200">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á</span>';
                else badge = '<span class="px-2.5 py-1 rounded-full text-xs bg-gray-50 text-gray-500 font-semibold border border-gray-200">‚è≥ ‡∏£‡∏≠‡∏™‡πà‡∏á</span>';
                return `<tr class="hover:bg-indigo-50/40">
            <td class="py-3 px-3 text-gray-400">${i + 1}</td>
            <td class="py-3 px-3 font-semibold text-gray-800">${sku.name}</td>
            <td class="py-3 px-3 text-center"><span class="px-2 py-0.5 rounded-full text-xs bg-indigo-50 text-indigo-600 border border-indigo-200 font-medium">${fmtMonth(sku.month)}</span></td>
            <td class="py-3 px-3 text-right text-blue-600 font-medium">${fmt(sku.forecast)}</td>
            <td class="py-3 px-3 text-right text-emerald-600 font-medium">${fmt(delivered)}</td>
            <td class="py-3 px-3 text-right ${isOver ? 'remaining-negative' : 'remaining-positive'}">${fmt(remain)}</td>
            <td class="py-3 px-3 text-center">${badge}</td>
        </tr>`;
            }).join('');
        }

        // ===== RENDER MASTER =====
        function renderMaster() {
            const skus = loadSKUs();
            const body = document.getElementById('masterBody');
            const empty = document.getElementById('emptyMaster');
            if (skus.length === 0) { body.innerHTML = ''; empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');
            // Group by month
            const grouped = {};
            skus.forEach((sku, i) => {
                const m = sku.month || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                if (!grouped[m]) grouped[m] = [];
                grouped[m].push({ ...sku, origIdx: i });
            });
            const sortedMonths = Object.keys(grouped).sort();
            let html = '';
            let num = 1;
            sortedMonths.forEach(month => {
                html += `<tr><td colspan="4" class="py-2.5 px-3 bg-gradient-to-r from-indigo-50 to-blue-50 font-bold text-indigo-700 text-sm border-b border-indigo-100">üìÖ ${month === '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' ? '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : fmtMonth(month)}</td></tr>`;
                grouped[month].forEach(sku => {
                    html += `<tr class="hover:bg-indigo-50/40">
        <td class="py-3 px-3 text-gray-400">${num++}</td>
        <td class="py-3 px-3 font-semibold text-gray-800">${sku.name}</td>
        <td class="py-3 px-3 text-right text-blue-600 font-medium">${fmt(sku.forecast)}</td>
        <td class="py-3 px-3 text-center">
            <button onclick="editSKU(${sku.origIdx})" class="px-2.5 py-1.5 rounded-lg text-xs font-medium bg-amber-50 text-amber-600 border border-amber-200 hover:bg-amber-100 transition-all mr-1">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button onclick="deleteSKU(${sku.origIdx})" class="px-2.5 py-1.5 rounded-lg text-xs font-medium bg-red-50 text-red-500 border border-red-200 hover:bg-red-100 transition-all">üóë ‡∏•‡∏ö</button>
        </td>
    </tr>`;
                });
            });
            body.innerHTML = html;
        }

        // ===== RENDER DELIVERIES =====
        function renderDeliveries() {
            const dels = loadDeliveries().sort((a, b) => a.date.localeCompare(b.date));
            const body = document.getElementById('deliveryBody');
            const empty = document.getElementById('emptyDelivery');
            if (dels.length === 0) { body.innerHTML = ''; empty.classList.remove('hidden'); document.getElementById('deliveryCount').textContent = ''; return; }
            empty.classList.add('hidden');
            document.getElementById('deliveryCount').textContent = dels.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
            body.innerHTML = dels.map((d, i) => `<tr class="hover:bg-indigo-50/40">
        <td class="py-3 px-3 text-gray-400">${i + 1}</td>
        <td class="py-3 px-3 text-gray-600">${d.date}</td>
        <td class="py-3 px-3 font-semibold text-gray-800">${d.sku}</td>
        <td class="py-3 px-3 text-gray-600">${d.lot || '-'}</td>
        <td class="py-3 px-3 text-right text-emerald-600 font-medium">${fmt(d.qty)}</td>
        <td class="py-3 px-3 text-center">
            <button onclick="deleteDelivery('${d.id}')" class="px-2.5 py-1.5 rounded-lg text-xs font-medium bg-red-50 text-red-500 border border-red-200 hover:bg-red-100 transition-all">üóë ‡∏•‡∏ö</button>
        </td>
    </tr>`).join('');
        }

        // ===== RENDER SKU SELECT =====
        function renderSKUSelect() {
            const sel = document.getElementById('selectSKU');
            const skus = loadSKUs();
            sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å SKU --</option>' + skus.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        }

        // ===== RENDER SKU DATALIST =====
        function renderSKUDatalist() {
            const datalist = document.getElementById('skuDatalist');
            const skus = loadSKUs();
            const uniqueNames = [...new Set(skus.map(s => s.name))];
            datalist.innerHTML = uniqueNames.map(name => `<option value="${name}">`).join('');
        }

        // ===== RENDER ALL =====
        function renderAll() { renderStats(); renderMonthFilter(); renderDashboard(); renderMaster(); renderDeliveries(); renderSKUSelect(); renderSKUDatalist(); renderCalendar(); }

        // ===== ACTIONS =====
        function addSKU(e) {
            e.preventDefault();
            const name = document.getElementById('inputSKU').value.trim();
            const month = document.getElementById('inputMonth').value;
            const forecast = parseFloat(document.getElementById('inputForecast').value);
            if (!name || !month) return;
            const skus = loadSKUs();
            if (skus.find(s => s.name.toLowerCase() === name.toLowerCase() && s.month === month)) {
                showToast('SKU ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß!', '‚ö†Ô∏è'); return;
            }
            skus.push({ name, month, forecast });
            saveSKUs(skus);
            document.getElementById('inputSKU').value = '';
            document.getElementById('inputForecast').value = '';
            showToast('‡πÄ‡∏û‡∏¥‡πà‡∏° SKU ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            renderAll();
        }

        function editSKU(idx) {
            const skus = loadSKUs();
            const sku = skus[idx];
            document.getElementById('editIdx').value = idx;
            document.getElementById('editName').value = sku.name;
            document.getElementById('editMonth').value = sku.month || '';
            document.getElementById('editForecast').value = sku.forecast;
            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        function saveEditSKU() {
            const idx = parseInt(document.getElementById('editIdx').value);
            const name = document.getElementById('editName').value.trim();
            const month = document.getElementById('editMonth').value;
            const forecast = parseFloat(document.getElementById('editForecast').value);
            if (!name || !month || isNaN(forecast) || forecast < 0) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', '‚ö†Ô∏è'); return; }
            const skus = loadSKUs();
            // Check duplicate (same name+month but different index)
            const dup = skus.findIndex((s, i) => i !== idx && s.name.toLowerCase() === name.toLowerCase() && s.month === month);
            if (dup !== -1) { showToast('SKU ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß!', '‚ö†Ô∏è'); return; }
            skus[idx] = { name, month, forecast };
            saveSKUs(skus);
            closeEditModal();
            showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            renderAll();
        }

        function deleteSKU(idx) {
            const skus = loadSKUs();
            if (!confirm(`‡∏•‡∏ö "${skus[idx].name}" ?\n‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà`)) return;
            skus.splice(idx, 1);
            saveSKUs(skus);
            showToast('‡∏•‡∏ö SKU ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'üóë');
            renderAll();
        }

        function addDelivery(e) {
            e.preventDefault();
            const date = document.getElementById('inputDate').value;
            const sku = document.getElementById('selectSKU').value;
            const lot = document.getElementById('inputLot').value.trim();
            const qty = parseFloat(document.getElementById('inputQty').value);
            if (!date || !sku || isNaN(qty)) return;
            const dels = loadDeliveries();
            dels.push({ id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6), date, sku, lot, qty });
            saveDeliveries(dels);
            document.getElementById('inputQty').value = '';
            document.getElementById('inputLot').value = '';
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            renderAll();
        }

        function deleteDelivery(id) {
            if (!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ô‡∏µ‡πâ?')) return;
            const dels = loadDeliveries().filter(d => d.id !== id);
            saveDeliveries(dels);
            showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'üóë');
            renderAll();
        }

        function confirmReset() {
            if (!confirm('‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?\n\nSKU, ‡πÅ‡∏ú‡∏ô‡∏à‡∏±‡∏î‡∏™‡πà‡∏á ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\n‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ')) return;
            localStorage.removeItem(STORAGE_KEY_SKU);
            localStorage.removeItem(STORAGE_KEY_DEL);
            localStorage.removeItem(STORAGE_KEY_PLAN);
            showToast('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'üóë');
            renderAll();
        }

        // ===== CALENDAR =====
        let calYear, calMonth;
        (function () { const n = new Date(); calYear = n.getFullYear(); calMonth = n.getMonth(); })();

        function calPrev() { calMonth--; if (calMonth < 0) { calMonth = 11; calYear--; } renderCalendar(); }
        function calNext() { calMonth++; if (calMonth > 11) { calMonth = 0; calYear++; } renderCalendar(); }

        function renderCalendar() {
            const MONTH_FULL = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
            document.getElementById('calTitle').textContent = 'üìÖ ' + MONTH_FULL[calMonth] + ' ' + calYear;

            const plans = loadPlans();
            const dels = loadDeliveries();
            const monthStr = calYear + '-' + String(calMonth + 1).padStart(2, '0');
            const firstDay = new Date(calYear, calMonth, 1).getDay();
            const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
            const today = new Date();
            const todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');

            let html = '';
            for (let i = 0; i < firstDay; i++) html += '<div class="bg-gray-50 min-h-[80px] p-1"></div>';

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = calYear + '-' + String(calMonth + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
                const dayPlans = plans.filter(p => p.date === dateStr);
                const dayDels = dels.filter(dl => dl.date === dateStr);
                const isToday = dateStr === todayStr;

                html += `<div class="bg-white min-h-[80px] p-1.5 cursor-pointer hover:bg-indigo-50/50 transition-colors" onclick="calAddPlan('${dateStr}')">`;
                html += `<div class="text-xs font-semibold mb-1 ${isToday ? 'bg-indigo-500 text-white w-6 h-6 rounded-full flex items-center justify-center' : 'text-gray-500'}">${d}</div>`;

                // Show plans (colored by SKU) - with checkmark if delivered
                dayPlans.forEach(p => {
                    const c = getSkuColor(p.sku);
                    // Check if this plan has matching delivery (same SKU, same date)
                    const matchedDel = dayDels.find(dl => dl.sku === p.sku);
                    const delQty = matchedDel ? Number(matchedDel.qty) : 0;
                    const planQty = Number(p.qty);
                    const isFull = matchedDel && delQty >= planQty;
                    const isPartial = matchedDel && delQty > 0 && delQty < planQty;
                    const icon = isFull ? '‚úÖ' : isPartial ? '‚òëÔ∏è' : 'üì¶';
                    const statusText = isFull ? '‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏ö' : isPartial ? `‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ${fmt(delQty)}/${fmt(planQty)}` : '‡πÅ‡∏ú‡∏ô';
                    const borderStyle = isFull ? `border:2px solid #22c55e` : isPartial ? `border:2px solid #eab308` : `border:1px solid ${c.border}`;

                    html += `<div class="text-[10px] leading-tight mb-0.5 px-1.5 py-0.5 rounded truncate font-semibold flex items-center justify-between group" style="background:${c.bg};${borderStyle};color:${c.text}" title="${statusText}: ${p.sku} ${fmt(planQty)}">`;
                    html += `<span>${icon} ${p.sku} ${fmt(planQty)}</span>`;
                    html += `<span class="hidden group-hover:inline cursor-pointer ml-1" onclick="event.stopPropagation();deletePlan('${p.id}')">‚úñ</span>`;
                    html += `</div>`;
                });

                // Show actual deliveries that don't have matching plan (extra deliveries)
                dayDels.forEach(dl => {
                    const matchedPlan = dayPlans.find(p => p.sku === dl.sku);
                    if (!matchedPlan) {
                        // Only show if no matching plan
                        html += `<div class="text-[10px] leading-tight mb-0.5 px-1.5 py-0.5 rounded truncate font-semibold" style="background:#dcfce7;border:2px solid #22c55e;color:#166534" title="‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á: ${dl.sku} ${fmt(dl.qty)}">`;
                        html += `‚úÖ ${dl.sku} ${fmt(dl.qty)}</div>`;
                    }
                });

                html += '</div>';
            }

            const totalCells = firstDay + daysInMonth;
            const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 0; i < remaining; i++) html += '<div class="bg-gray-50 min-h-[80px] p-1"></div>';

            document.getElementById('calGrid').innerHTML = html;

            // === Legend ===
            const skuNames = [...new Set(loadSKUs().map(s => s.name))];
            document.getElementById('calLegend').innerHTML = skuNames.map(name => {
                const c = getSkuColor(name);
                return `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-semibold" style="background:${c.bg};border:1px solid ${c.border};color:${c.text}">‚óè ${name}</span>`;
            }).join('');

            // === Banner ===
            const monthPlans = plans.filter(p => p.date.substring(0, 7) === monthStr);
            const monthDels = dels.filter(d => d.date.substring(0, 7) === monthStr);
            const totalPlan = monthPlans.reduce((s, p) => s + Number(p.qty), 0);
            const totalActual = monthDels.reduce((s, d) => s + Number(d.qty), 0);
            const calPct = totalPlan > 0 ? Math.min((totalActual / totalPlan) * 100, 100) : 0;
            document.getElementById('calBannerPlan').textContent = fmt(totalPlan);
            document.getElementById('calBannerActual').textContent = fmt(totalActual);
            document.getElementById('calBannerPct').textContent = calPct.toFixed(1) + '%';

            // === Summary Table ===
            const allSkus = loadSKUs();
            const allNames = [...new Set([...monthPlans.map(p => p.sku), ...monthDels.map(d => d.sku)])];
            let grandForecast = 0, grandPlan = 0, grandActual = 0;
            document.getElementById('calSummaryBody').innerHTML = allNames.map(name => {
                const c = getSkuColor(name);
                const skuForecast = allSkus.filter(s => s.name === name && s.month === monthStr).reduce((s, sk) => s + Number(sk.forecast), 0);
                const pQty = monthPlans.filter(p => p.sku === name).reduce((s, p) => s + Number(p.qty), 0);
                const aQty = monthDels.filter(d => d.sku === name).reduce((s, d) => s + Number(d.qty), 0);
                const remain1 = skuForecast - pQty; // Forecast - ‡πÅ‡∏ú‡∏ô
                const remain2 = pQty - aQty;         // ‡πÅ‡∏ú‡∏ô - ‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á
                grandForecast += skuForecast; grandPlan += pQty; grandActual += aQty;
                const remainColor1 = remain1 <= 0 ? 'text-emerald-600' : 'text-red-600';
                return `<tr class="hover:bg-gray-50">
                    <td class="py-2.5 px-3"><span class="inline-block w-4 h-4 rounded" style="background:${c.bg};border:2px solid ${c.border}"></span></td>
                    <td class="py-2.5 px-3 font-semibold text-gray-800">${name}</td>
                    <td class="py-2.5 px-3 text-right font-medium text-purple-600 bg-indigo-50/20">${fmt(skuForecast)}</td>
                    <td class="py-2.5 px-3 text-right font-medium text-blue-600 bg-indigo-50/20">${fmt(pQty)}</td>
                    <td class="py-2.5 px-3 text-right font-bold bg-indigo-50/20 border-r border-gray-200 ${remainColor1}">${fmt(remain1)}</td>
                    <td class="py-2.5 px-3 text-right font-medium text-blue-600 bg-emerald-50/20">${fmt(pQty)}</td>
                    <td class="py-2.5 px-3 text-right font-medium text-emerald-600 bg-emerald-50/20">${fmt(aQty)}</td>
                    <td class="py-2.5 px-3 text-right font-bold bg-emerald-50/20 ${remain2 <= 0 ? 'text-emerald-600' : 'text-red-600'}">${fmt(remain2)}</td>
                </tr>`;
            }).join('');
            const grandRemain1 = grandForecast - grandPlan;
            const grandRemain2 = grandPlan - grandActual;
            const gRemainColor1 = grandRemain1 <= 0 ? 'text-emerald-700' : 'text-red-700';
            document.getElementById('calSummaryFoot').innerHTML = `<tr class="font-bold">
                <td class="py-3 px-3"></td>
                <td class="py-3 px-3 text-gray-800">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
                <td class="py-3 px-3 text-right text-purple-700 bg-indigo-50/30">${fmt(grandForecast)}</td>
                <td class="py-3 px-3 text-right text-blue-700 bg-indigo-50/30">${fmt(grandPlan)}</td>
                <td class="py-3 px-3 text-right bg-indigo-50/30 border-r border-gray-200 ${gRemainColor1}">${fmt(grandRemain1)}</td>
                <td class="py-3 px-3 text-right text-blue-700 bg-emerald-50/30">${fmt(grandPlan)}</td>
                <td class="py-3 px-3 text-right text-emerald-700 bg-emerald-50/30">${fmt(grandActual)}</td>
                <td class="py-3 px-3 text-right bg-emerald-50/30 ${grandRemain2 <= 0 ? 'text-emerald-700' : 'text-red-700'}">${fmt(grandRemain2)}</td>
            </tr>`;
        }

        function calAddPlan(dateStr) {
            const skus = loadSKUs();
            if (skus.length === 0) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° SKU ‡∏Å‡πà‡∏≠‡∏ô', '‚ö†Ô∏è'); return; }
            const skuNames = [...new Set(skus.map(s => s.name))];
            let msg = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å SKU (‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç):\n';
            skuNames.forEach((s, i) => msg += (i + 1) + '. ' + s + '\n');
            const choice = prompt(msg + '\nüìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ' + dateStr);
            if (!choice) return;
            const idx = parseInt(choice) - 1;
            if (isNaN(idx) || idx < 0 || idx >= skuNames.length) { showToast('‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‚ö†Ô∏è'); return; }
            const qty = prompt('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ú‡∏ô‡∏™‡πà‡∏á ' + skuNames[idx] + ' ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ' + dateStr + ':');
            if (!qty) return;
            const qtyVal = parseFloat(qty);
            if (isNaN(qtyVal) || qtyVal <= 0) { showToast('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‚ö†Ô∏è'); return; }
            const pls = loadPlans();
            pls.push({ id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6), date: dateStr, sku: skuNames[idx], qty: qtyVal });
            savePlans(pls);
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            renderAll();
        }

        function deletePlan(id) {
            const pls = loadPlans().filter(p => p.id !== id);
            savePlans(pls);
            showToast('‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'üóë');
            renderAll();
        }

        function migrateToPlans() {
            const dels = loadDeliveries();
            if (dels.length === 0) { showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≤‡∏¢', '‚ö†Ô∏è'); return; }
            if (!confirm('‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (' + dels.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) ‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô "‡πÅ‡∏ú‡∏ô‡∏à‡∏±‡∏î‡∏™‡πà‡∏á" ?\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ú‡∏ô‡∏ö‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô')) return;
            const pls = loadPlans();
            dels.forEach(d => {
                pls.push({ id: d.id, date: d.date, sku: d.sku, qty: d.qty });
            });
            savePlans(pls);
            saveDeliveries([]);
            showToast('‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ' + dels.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            renderAll();
        }

        // ===== AUTO MIGRATE DELIVERIES TO PLANS =====
        function autoMigrateDeliveriesToPlans() {
            const dels = loadDeliveries();
            if (dels.length === 0) return;
            const pls = loadPlans();
            // Check if already migrated (avoid duplicates)
            const existingIds = new Set(pls.map(p => p.id));
            let migrated = 0;
            dels.forEach(d => {
                if (!existingIds.has(d.id)) {
                    pls.push({ id: d.id, date: d.date, sku: d.sku, qty: d.qty });
                    migrated++;
                }
            });
            if (migrated > 0) {
                savePlans(pls);
                saveDeliveries([]);
                console.log('Auto-migrated ' + migrated + ' deliveries to plans');
            }
        }

        // ===== PUSH ALL LOCAL DATA TO GOOGLE SHEETS =====
        async function pushAllToSheets() {
            if (!GAS_URL) { console.log('GAS_URL not set, skip push'); return; }
            try {
                showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏∂‡πâ‡∏ô Google Sheets...', 'üîÑ');
                const skus = loadSKUs();
                const dels = loadDeliveries();
                const plans = loadPlans();

                const results = await Promise.all([
                    fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: 'save', sheet: 'SKUs', data: skus })
                    }).then(r => r.json()),
                    fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: 'save', sheet: 'Deliveries', data: dels })
                    }).then(r => r.json()),
                    fetch(GAS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: 'save', sheet: 'Plans', data: plans })
                    }).then(r => r.json())
                ]);

                console.log('Push results:', results);
                showToast(`‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! SKU: ${skus.length}, Plans: ${plans.length}`, '‚òÅÔ∏è');
            } catch (err) {
                console.warn('Push error:', err);
                showToast('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', '‚ùå');
            }
        }

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('inputDate').valueAsDate = new Date();
            const now = new Date();
            document.getElementById('inputMonth').value = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');

            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets
            await loadFromSheets();
        });
    </script>

</body>

</html>